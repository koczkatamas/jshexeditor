<!DOCTYPE html>

<html lang="en">
<head>
    <meta charset="utf-8" />
    <title>HexViewer</title>
    <script src="https://code.jquery.com/jquery-3.1.1.min.js"></script>
    <!--<link rel="stylesheet" type="text/css" href="https://cdnjs.cloudflare.com/ajax/libs/malihu-custom-scrollbar-plugin/3.1.5/jquery.mCustomScrollbar.css" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/malihu-custom-scrollbar-plugin/3.1.5/jquery.mCustomScrollbar.js"></script>-->
    <script src="/js/autorefresh.js"></script>
    <style>
        #hexView { font-family: Courier,monospace; font-size: 12px; }
        #hexView, #hexView .content { height: 400px; }

        .addrPart {
            color: #ccc;
        }

        .hexPart {
            margin-left: 8px;
        }

        .asciiPart {
            margin-left: 8px;
        }

        .hexcell {
            margin: 3px;
        }

        .hexcell.cell8 {
            margin-left: 8px;
        }
    </style>
    <script>
        dataProvider = {
            length: 0x10000 - 3,
            get(offset, length){
                var res = [];
                for (var i = 0; i < length; i++)
                    res.push((((offset + i) * 12345) % 98765) % 256);
                return res;
            }
        }

        class HexViewUtils {
            static zeroFill(str, padLen) {
                while (str.length < padLen)
                    str = '0' + str;
                return str;
            }

            static addrHex(address){
                //var addrHexLen = Math.ceil(Math.log(this.buffer.length) / Math.log(16));
                var addrHexLen = 8;
                return this.zeroFill(address.toString(16), addrHexLen);
            }

            static byteAscii(bt) {
                return bt == 32 ? '\u00a0' : bt < 32 || (0x7f <= bt && bt <= 0xa0) || bt == 0xad ? '.' : String.fromCharCode(bt);
            }

            static byteHex(bt) {
                return this.zeroFill(bt.toString(16), 2);
            }

            static generateRow() {
                function cr(tag, className) {
                    var elem = document.createElement(tag);
                    elem.className = className;
                    return elem;
                }

                var hexRow = cr('div', 'hexRow');
                hexRow.addrPart = cr('span', 'addrPart');
                hexRow.hexPart = cr('span', 'hexPart');
                hexRow.asciiPart = cr('span', 'asciiPart');
                hexRow.appendChild(hexRow.addrPart);
                hexRow.appendChild(hexRow.hexPart);
                hexRow.appendChild(hexRow.asciiPart);

                for (var iChar = 0; iChar < bytesPerLine; iChar++) {
                    hexRow.asciiPart.appendChild(cr('span', `asciicell cell${iChar}`));
                    hexRow.hexPart.appendChild(cr('span', `hexcell cell${iChar}`));
                }

                return hexRow;
            }
        }

        var bytesPerLine = 16;
        $(() => {
            var rows = [];
            var topRow = 0;
            var rowHeight = 15;

            var scrollbox = $(".scrollbox");
            var content = $(".scrollbox .content");
            var heightbox = $(".scrollbox .heightbox");
            var totalRowCount = Math.ceil(dataProvider.length / bytesPerLine);
            var totalHeight = totalRowCount * rowHeight;
            heightbox.height(totalHeight);
            var boxHeight = scrollbox.height();
            var maxScrollHeight = totalHeight - boxHeight;
            var rowCount = Math.ceil(boxHeight / rowHeight);
            var maxRow = Math.ceil(dataProvider.length / bytesPerLine - rowCount + 1);
            console.log(boxHeight, rowCount);
            for (var i = 0; i < rowCount; i++) {
                var row = HexViewUtils.generateRow();
                rows[i] = row;
                content.append(row);
            }

            function refresh() {
                var startOffset = topRow * bytesPerLine;
                var data = dataProvider.get(startOffset, Math.min(rowCount * bytesPerLine, dataProvider.length - startOffset));
                for (var iRow = 0; iRow < rowCount; iRow++) {
                    var rowOffset = iRow * bytesPerLine;
                    var row = rows[iRow];
                    row.addrPart.innerText = rowOffset < data.length ? HexViewUtils.addrHex(startOffset + rowOffset) : '';

                    for (var iCell = 0; iCell < bytesPerLine; iCell++) {
                        var dataOffset = rowOffset + iCell;
                        var hexCh, ch;
                        if (dataOffset < data.length) {
                            var b = data[rowOffset + iCell];
                            hexCh = HexViewUtils.byteHex(b);
                            ch = HexViewUtils.byteAscii(b);
                        } else {
                            hexCh = '\u00a0\u00a0';
                            ch = '\u00a0';
                        }

                        row.hexPart.childNodes[iCell].innerText = hexCh;
                        row.asciiPart.childNodes[iCell].innerText = ch;
                    }
                }
            }

            refresh();

            $(".scrollbox").on('scroll', e => {
                var scrollTop = scrollbox.scrollTop();
                content.css('top', scrollTop + 'px');
                var percent = scrollTop / maxScrollHeight;
                topRow = Math.round(maxRow * percent);
                console.log(scrollTop, percent);
                refresh();
            });
            //scrollbox.mCustomScrollbar();
        });
    </script>
    <style>
        .scrollbox { overflow-y: scroll; }
        .scrollbox .heightbox { height:10000px; background:blue; float:left }
        .scrollbox .content { position: relative; overflow: hidden }
    </style>
</head>
<body>
    <h1>HexViewer</h1>
    <div id="hexView" class="scrollbox">
        <div class="heightbox"></div>
        <div class="content"></div>
    </div>
</body>
</html>